# Nome do seu workflow
name: CI - Testes de API com Maven

# Define os "gatilhos" (triggers)
on:
  # 1. Gatilho Padrão: Push na 'main'
  push:
    branches: [ "main" ]
  # 2. Gatilho Padrão: Pull Request para 'main'
  pull_request:
    branches: [ "main" ]

  # 3. [A NOVA ATUALIZAÇÃO]
  #    Gatilho Manual: Permite rodar pela interface do GitHub
  workflow_dispatch:

# Permissões para que a Action possa publicar no GitHub Pages
permissions:
  contents: write 

jobs:
  build-and-test:
    # Máquina virtual que executará os testes
    runs-on: ubuntu-latest
    
    # Passos (steps) do job
    steps:
      # 1. Baixa o seu código do repositório
      - name: Checkout do código
        uses: actions/checkout@v4

      # 2. Configura o ambiente Java 17
      - name: Configurar o JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          # Cache do Maven (para acelerar o download de dependências)
          cache: 'maven' 

      # 3. Roda os testes (o '|| true' garante que a pipeline continue)
      - name: Executar os testes com Maven
        run: mvn clean test || true

      # 4. Step de Debug: Lista os arquivos de resultado gerados
      - name: Listar arquivos para Debug (Verificar allure-results)
        if: always()
        run: |
          echo "Listando conteúdo de target/allure-results/ para confirmar os 3 testes:"
          ls -l target/allure-results/

      # 5. Gera o Relatório Allure usando o Docker Oficial (evita cache)
      - name: Gerar Relatório Allure (via Docker Oficial)
        if: always()
        run: |
          echo "Gerando o relatório a partir dos arquivos..."
          # Mapeia os resultados (target/allure-results) para dentro do container
          # Mapeia a pasta de saída (allure-report) para fora do container
          # Roda o comando 'allure generate' com a flag --clean
          docker run --rm \
            -v $(pwd)/target/allure-results:/app/allure-results \
            -v $(pwd)/allure-report:/app/allure-report \
            frankescobar/allure-docker-service \
            allure generate /app/allure-results -o /app/allure-report --clean

      # 6. Publica o relatório (pasta 'allure-report') no GitHub Pages
      - name: Deploy do Relatório para GitHub Pages
        # Só publica se for um push na 'main'
        if: (always() && github.ref == 'refs/heads/main')
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # A pasta que contém o HTML para publicar
          publish_dir: ./allure-report
          # Força a limpeza do cache do site
          force_orphan: true